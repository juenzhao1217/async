# async

##### Nodejs异步流程控制Async

**前言**

Nodejs框架类库很多，功能相近的框架，本来只打算学一种写一种。之前写过流程控制框架[windjs文章](http://blog.fens.me/nodejs-async-windjs/)，本来是想着要支持一下“国人框架”。无奈啊，作者竟然放弃了维护，国人真的不靠谱啊！

“流程控制”本来是件比较简单的事，但是由于Nodejs的异步架构的实现方法，对于需要同步的业务逻辑，实现起来就比较麻烦。嵌套3-4层，代码就会变得的支离破碎了！

今天就遇到了一个业务逻辑，连续对数据库操作，前后有依赖。让我们看看Async是如何解决问题的。

不用不知道，一用真强大！！

##### each与map区别

- each: 如果想对同一个集合中的所有元素都执行同一个异步操作。
- map: 对集合中的每一个元素，执行某个异步操作，得到结果。所有的结果将汇总到最终的callback里。与each的区别是，each只关心操作不管最后的值，而map关心的最后产生的值。

`coll`通过`iteratee`函数映射每个值来生成新的值集合。在`iteratee`被称为从一个项目`coll` ，当它已经完成处理回调。这些回调中的每一个都有两个参数：an `error`和已转换的项`coll`。如果 `iteratee`将错误传递给其回调，则主`callback`（对于 `map`函数）将立即被调用，并显示错误。

请注意，由于此功能`iteratee`并行应用于每个项目，因此不能保证`iteratee`功能将按顺序完成。但是，结果数组将与原来的顺序相同`coll`。

如果`map`传递一个Object，结果将是一个Array。结果将大致按照原始对象的键的顺序（但是JavaScript可能会有所不同）。



##### 参数：

| 名称         | 类型                                       | 描述                                       |
| ---------- | ---------------------------------------- | ---------------------------------------- |
| `coll`     | 数组 \| 可替代 \| 目的                          | 要迭代的集合。                                  |
| `iteratee` | [异步功能](http://caolan.github.io/async/global.html) | 应用于每个项目的异步功能 `coll`。迭代应该用转换的项目完成。用（项目，回调）调用。 |
| `callback` | 功能 <可选>                                  | 所有`iteratee` 函数完成后调用的回调，或发生错误。结果是一个转换项目的数组`coll`。用（err，results）调用。 |

##### 例

```
async.map(['file1','file2','file3'], fs.stat, function(err, results) {
    // results is now an array of stats for each file
});
```





